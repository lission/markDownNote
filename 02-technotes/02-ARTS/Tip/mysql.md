[TOC]

# mysql架构

## mysql的执行流程

![img](https://github.com/lission/markdownPics/blob/main/mysql/MySQL%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B.png?raw=true)

- 连接

- 查询缓存，mysql内部自带一个缓存模块，MySQL 的缓存默认是关闭的。**在 MySQL8.0 中，查询缓存已经被移除了。**

  > MySql自带缓存应用场景有限：
  >
  > - SQL 语句必须一模一样，中间多一个空格，字母大小写不同，都会被认为是不同的 SQL 
  > - 表中任意一条数据发生变化的时候，这张表的缓存都会失效。所以，对于有大量数据更新的应用，也不合适
  >
  > **所以缓存这一块，我们还是交给 ORM 框架（比如 MyBatis 默认开启了一级缓存），或者独立的缓存服务，比如 Redis 来处理更为合适。**

- 解析器，Parser 解析器，对语句基于 SQL 语法进行词法和语法分析，以及语义的解析。语法解析是根据 SQL 语句生成一个数据结构。**这个结构我们把它叫做解析树**
- 预处理器，Preprocessor，**它会检查生成的解析树，解决解析器无法分析的语义。比如，它会检查表和列名是否存在，检查名字和别名，保证没有歧义。**预处理之后得到一个新的解析树。
- 查询优化器，Optimizer，查询优化器的目的就是根据解析树生成不同的`执行计划（Execution Plan）`，然后选择一种最优的执行计划，MySQL 里面使用的是基于开销（cost）的优化器，哪种执行计划开销最小，就用哪种。
- 执行计划。Execution Plan，查询优化器基于解析树以最小开销原则生成选择执行计划
- 执行引擎和存储引擎，执行引擎利用存储引擎提供的相应的 API 来完成操作，最后把数据返回给客户端



# 存储引擎

## MyISAM

> 不支持事务，性能更好，数据占用空间小。锁级别为表级锁，并发性差。

**数据表底层结构**

每张表对应生成三个文件

- frm文件：表结构定义文件，存储与表相关的元数据(meta)信息
- MYD文件：MyISAM存储引擎专用，存放MyISAM表的数据(data)
- MYI文件：MyISAM存储引擎专用，存放MyISAM表的索引相关信息

**mysql8.0从元数据中移除了frm文件**

**适用场景**

- 非事务型应用
- 只读类应用(可以压缩表)，存档数据

## InnoDB

> Mysql 5.7中的默认存储引擎，InnoDB是一个事务安全存储引擎。支持行级锁和表锁，支持读写并发，写不阻塞(MVCC)。InnoDB 将用户数据存储在`聚集索引`中(索引和记录在一起存储)，以减少基于主键的常见查询 I/O 。

InnoDB 对应两个文件： 表结构文件 `.frm `、数据文件 `.ibd`；表最大为 64TB。

**适用场景**

- 经常更新表，存在并发读写或者有事务处理的业务系统
- 并发业务多，需要考虑读写互不干扰，保证比较高的数据一致性的场景

## MyISAM和InnoDB对比

- 事务和外键
  - InnoDB支持事务，具有安全性和完整性，适合大量insert和update操作
  - MyISAM不支持事务，提供高速检索，适合大量select操作
- 锁机制
  - InnoDB支持行级锁和表级锁，基于索引实现
  - MyISAM只支持表级锁
- 索引结构
  - InnoDB使用**聚集索引(聚簇索引)，索引和记录在一起存储**
  - MyISAM使用**非聚集索引(非聚簇索引)，索引和记录分开存储**
- 并发处理能力
  - InnoDB读写阻塞与隔离级别有关，可以采用多版本并发控制MVCC支持高并发
  - MyISAM使用表锁，写操作并发率低，读写阻塞
- 存储文件
  - InnoDB 对应两个文件： 表结构文件 `.frm `、数据文件 `.ibd`；表最大为 64TB。
  - MyISAM 对应三个文件：表结构文件 `.frm`、表数据文件`.MYD`、索引文件`.MYI`；从 MySQL5.0 开始默认限制是 256TB
  - **mysql8.0从元数据中移除了frm文件**
- 适用场景
  - InnoDB读写阻塞与隔离级别有关，可以采用多版本并发控制MVCC支持高并发
    - 经常更新表，存在并发读写或者有事务处理的业务系统
    - 并发业务多，需要考虑读写互不干扰，保证比较高的数据一致性的场景
  - MyISAM
    - 非事务型应用
    - 只读类应用(可以压缩表)，存档数据

# 索引

## 索引的分类

索引，数据库管理系统(DBMS)的一个**排序**的数据结构，以协助快速查询、更新数据库表中的数据。

### 应用层面

- 普通索引，也叫做非唯一索引，是普通索引，没有任何限制
- 唯一索引，要求键值不重复
- 主键索引，是一种特殊的唯一索引，它还多了一个限制条件，要求**键值不能为空**。主键索引用 **Primay key**创建
- 复合索引，又称为联合索引，是在多个列上创建的索引。创建复合索引最重要的是**列顺序**的选择，这关系到索引能否使用上，或者影响多少个谓词条件能使用上索引。**复合索引的使用遵循最左匹配原则**，只有索引左边的列匹配到，后面的列才能继续匹配

### 数据与键值逻辑

- 聚集索引，**(聚簇索引)，索引和记录在一起存储**，一个索引值对应一行记录。
  - 如果一张表创建了主键索引，那么主键索引就是聚簇索引
  - 如果没有主键，则为第一个非空唯一索引
  - 没有非空唯一索引，则为 InnoDB 内置的 ROWID
- 非聚集索引，**(非聚簇索引)，索引和记录分开存储**。二级索引/辅助索引

### 数据结构

- B树，是一种自平衡的m阶树，能够保持数据有序，B表示平衡balance。[数据结构说明](./Tip/数据结构.md)

- B+树，在B树基础上，为叶子节点增加链表指针（B树+叶子有序链表），所有关键字都在叶子节点上，非叶子节点作为叶子节点的索引。InnoDB 就是使用 B+树。[数据结构说明](./Tip/数据结构.md)

- Hash索引，查询效率高，可以一次性定位。在 InnoDB 中，不能显示地创建一个哈希索引（**所谓支持哈希索引只的 自适应哈希索引（Adaptive Hash Index），它是 InnoDB 自动为 Buffer Pool 中的热点页创建的索引**）。

  **Memory 存储引擎可以使用哈希索引**

  > 缺陷：
  >
  > - 不能用于范围查询
  > - 不能避免表扫描
  > - 大量hash重复时，性能欠佳

- FullText索引，全文索引，目前仅用于char、vachar、text这三种类型
- R树索引，比较少见，主要用于空间数据索引
