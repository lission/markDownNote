[TOC]

# 一、基础

## 1.1、网络分层

从不同维度，可以由3种分类方式。

- OSI七层：
应用层、表示层、会话层、传输层、网络层、数据链路层、物理层
- TCP/IP 五层：
应用层(**应用层、表示层、会话层**)、传输层、网络层、数据链路层、物理层
- TCP/IP 四层：
应用层(应用层、表示层、会话层)、传输层、网络层、网络接口层(**数据链路层、物理层**)

## 1.2、TCP/IP 四层网络模型

为何要有TCP/IP网络模型？

对于同一台设备上的进程间通信，有很多种方式，比如管道、消息队列、共享内存、信号等方式，而对于不同设备上的进程间通信，就需要网络通信，为兼容多种多样的设备，就协商出了一套**通用的网络协议**。

该网络协议分层，每一层有各自的作用和职责

## 1.3、应用层

我们能直接接触到的就是**应用层**（Application Layer），电脑或手机使用的应用软件都是在应用层实现的。当两个不同设备的应用需要通信时，应用就把应用数据传给下一层，也就是传输层。

应用层只需要专注于为用户提供应用功能，比如 HTTP、FTP、Telnet、DNS、SMTP等。

**应用层是不用去关心数据是如何传输的**，就类似于，我们寄快递的时候，只需要把包裹交给快递员，由他负责运输快递，我们不需要关心快递是如何被运输的。

而且**应用层是工作在操作系统中的用户态**，传输层及以下则工作在内核态。

## 1.4、传输层

应用层的数据包会传给传输层，传输层（Transport Layer）是为应用层提供网络支持的。输层协议只需要服务好应用，作为**应用间数据传输的媒介**，**帮助实现应用到应用的通信**，而实际的传输功能就交给下一层。

用来建立端口到端口的通信机制。

> 设备：四层交换机、四层路由器

![img](https://raw.githubusercontent.com/lission/markdownPics/main/network/%E5%BA%94%E7%94%A8%E5%B1%82.webp)

传输层有两个传输协议，分别是TCP和UDP。

TCP 的全称叫传输控制协议（*Transmission Control Protocol*），大部分应用使用的正是 TCP 传输层协议，比如 HTTP 应用层协议。TCP 相比 UDP 多了很多特性，比如流量控制、超时重传、拥塞控制等，这些都是为了保证数据包能可靠地传输给对方。

UDP 相对来说就很简单，简单到只负责发送数据包，不保证数据包是否能抵达对方，但它实时性相对更好，传输效率也高。当然，UDP 也可以实现可靠传输，把 TCP 的特性在应用层上实现就可以，不过要实现一个商用的可靠 UDP 传输协议，也不是一件简单的事情。

应用需要传输的数据可能会非常大，如果直接传输就不好控制，因此当传输层的数据包大小超过 MSS（TCP 最大报文段长度） ，就要将数据包分块，这样即使中途有一个分块丢失或损坏了，只需要重新发送这一个分块，而不用重新发送整个数据包。在 TCP 协议中，我们把每个分块称为一个 **TCP 段**（*TCP Segment*）。

![img](https://raw.githubusercontent.com/lission/markdownPics/main/network/TCP%E6%AE%B5.webp)

当设备作为接收方时，传输层则要负责把数据包传给应用，但是一台设备上可能会有很多应用在接收或者传输数据，因此需要**用一个编号将应用区分开来**，这个编号就是**端口**。

比如 80 端口通常是 Web 服务器用的，22 端口通常是远程登录服务器用的。而对于浏览器（客户端）中的每个标签栏都是一个独立的进程，操作系统会为这些进程分配临时的端口号。

由于传输层的报文中会携带端口号，因此接收方可以识别出该报文是发送给哪个应用。

### 1.4.1、端口

- **应用程序与网卡关联的编号**
- 取值范围：0～65535	
- 系统保留端口(BSD保留端口)：0～1023	
- 用户可注册的端口范围：1024～49151
- 随机动态端口：49152～65535

### 1.4.2、TCP传输控制协议

- **定义**：Transmission Control Protocol **传输控制协议**，一种**可靠传输协议**

- **长度**：无长度限制，但为了保证效率，通常不会超过IP数据包的长度(65535Byte)，确保单个TCP数据包不再分割。

- **数据结构：**

  > ![img](https://github.com/lission/markdownPics/blob/main/network/TCP%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84.png?raw=true)

- **交互流程**

  1. 建立连接，三次握手，客户端-服务器模式

     > 客户端-服务端模式：
     >
     > - 主动发起建立连接的应用进程叫客户端
     > - 被动等待连接建立的应用进程叫服务端
     >
     > 三次握手过程：
     >
     > 1. 客户端向服务端发送一个SYN
     > 2. 服务端接收到SYN后，向客户端发送一个SYN_ACK
     > 3. 客户端接收到SYN_ACK后，再给服务端发送一个ACK

  2. 数据传输

  3. 连接释放，四次挥手

     > 四次挥手过程：
     >
     > 1. 客户端向服务端发送一个FIN
     > 2. 服务端接收到FIN后，向客户端发送ACK，表示我接收到了断开连接请求，客户端可以不发送数据，服务端可能还有数据在处理
     > 3. 服务端处理完所有数据后，向客户端发送FIN，表示服务端现在可以断开连接了
     > 4. 客户端接收到FIN，向服务端发送ACK，表示客户端也会断开连接了

### 1.4.3、UDP

- **定义**：User Datagram Protocol 用户数据报协议，一种**不可靠的传输协议**

- **长度**：有长度限制，Head 8 byte，总长度不超过655535Byte，正好放进一个IP数据包

- **数据结构：**

  > ![img](https://github.com/lission/markdownPics/blob/main/network/UDP%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84.png?raw=true)

## 1.5、网络层

网络层（Internet Layer），负责应用间实际的数据传输功能。

![网络层](https://raw.githubusercontent.com/lission/markdownPics/main/network/%E7%BD%91%E7%BB%9C%E5%B1%82.webp)

网络层最长使用的是IP（Internet Protocol）协议，IP 协议会**将传输层的报文作为数据部分**，再加上 **IP 包头组装成 IP 报文**，如果 IP 报文大小超过 MTU（以太网中一般为 1500 字节）就会**再次进行分片**，得到一个即将发送到网络的 IP 报文。

![IP结构](https://raw.githubusercontent.com/lission/markdownPics/main/network/IP%E7%BB%93%E6%9E%84.webp)

**网络层负责将数据从一个设备传输到另一个设备**，世界上那么多设备，又该如何找到对方呢？因此，网络层需要有区分设备的编号。

一般**用 IP 地址给设备进行编号**，对于 IPv4 协议， IP 地址共 32 位，分成了四段（比如，192.168.100.1），每段是 8 位。只有一个单纯的 IP 地址虽然做到了区分设备，但是寻址起来就特别麻烦，全世界那么多台设备，难道一个一个去匹配？这显然不科学。

因此，需要将 IP 地址分成两种意义：

- 一个是**网络号**，负责标识该 IP 地址是属于哪个「子网」的；
- 一个是**主机号**，负责标识同一「子网」下的不同主机；

怎么分的呢？这需要配合**子网掩码**才能算出 IP 地址 的网络号和主机号。

比如 10.100.122.0/24，后面的`/24`表示就是 `255.255.255.0` 子网掩码，255.255.255.0 二进制是「11111111-11111111-11111111-00000000」，大家数数一共多少个1？不用数了，是 24 个1，为了简化子网掩码的表示，用/24代替255.255.255.0。

知道了子网掩码，该怎么计算出网络地址和主机地址呢？

将 10.100.122.2 和 255.255.255.0 进行**按位与运算**，就可以得到网络号，如下图：

![ip与子网掩码](https://raw.githubusercontent.com/lission/markdownPics/main/network/IP%E5%9C%B0%E5%9D%80%E4%B8%8E%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81.webp)

将 255.255.255.0 取反后与IP地址进行进行**按位与运算**，就可以得到**主机号**。

![子网掩码计算器](https://raw.githubusercontent.com/lission/markdownPics/main/network/%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81%E8%AE%A1%E7%AE%97%E5%99%A8.webp)

**在寻址的过程中，先匹配到相同的网络号**（表示要找到同一个子网），才会去找对应的主机。

除了寻址能力， IP 协议还有另一个重要的能力就是**路由**。实际场景中，两台设备并不是用一条网线连接起来的，而是通过很多网关、路由器、交换机等众多网络设备连接起来的，那么就会形成很多条网络的路径，因此**当数据包到达一个网络节点，就需要==通过路由算法==决定下一步走哪条路径**。

路由器寻址工作中，就是要找到目标地址的子网，找到后进而把数据包转发给对应的网络内。

![路由器寻址](https://raw.githubusercontent.com/lission/markdownPics/main/network/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AF%BB%E5%9D%80.webp)



**IP 协议的寻址作用是告诉我们去往下一个目的地该朝哪个方向走，路由则是根据「下一个目的地」选择路径。寻址更像在导航，路由更像在操作方向盘**





**定义**：引入一套新的地址来区分不同的广播域/子网，这套地址叫做网络地址

> 设备：路由器、三层交换机

### IP(网际互联协议 Internet Protocol)
- IP的作用：

  - 为每一台计算机分配IP地址
  - 确定哪些地址在同一个子网络中

- IP地址

  - IP地址分类

    - IPv4

      > 网络地址由**32位二进制数表示**
      > 通常写为**4段十进制数**
      > 取值范围0.0.0.0~255.255.255.255

    - IPv6

  - IP地址构成

    - 网络部分，用来标识子网
    - 主机部分，用来标识主机

- 子网掩码，表示子网络特征的一个参数，**形式上等同于IP地址，网络部分全为1，主机部分全为0**

  > 使用方法：将两个ip地址分别与子网掩码进行&运算，结果相同则说明两个ip在同一子网种

- IP数据包，直接放入以太网的Data部分，以太网数据包Data最长1500Byte，因此若IP数据包超过此长度， 会被分割为多个以太网数据包，分开发送

  > 构成:
  >
  > - Head，20～60Byte
  > - Data，最长65515Byte 

- ARP，用于实现从IP地址到MAC地址的映射

## 1.6、网络接口层

生成了 IP 头部之后，接下来要交给**网络接口层**（*Link Layer*）在 IP 头部的前面加上 MAC 头部，并封装成数据帧（Data frame）发送到网络上。

![网络接口层](https://raw.githubusercontent.com/lission/markdownPics/main/network/%E7%BD%91%E7%BB%9C%E6%8E%A5%E5%8F%A3%E5%B1%82.webp)



IP 头部中的接收方 IP 地址表示网络包的目的地，通过这个地址我们就可以判断要将包发到哪里，但在以太网的世界中，这个思路是行不通的。

什么是以太网呢？电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分。**以太网就是一种在==「局域网」==内，把附近的==设备连接起来==，使它们之间可以==进行通讯==的技术**。

以太网在判断网络包目的地时和 IP 的方式不同，因此必须采用相匹配的方式才能在以太网中将包发往目的地，而 MAC 头部就是干这个用的，所以，在**以太网进行通讯要用到 MAC 地址**。

**MAC 头部是以太网使用的头部**，它包含了**接收方和发送方的 MAC 地址等信息**，我们可以通过 **ARP 协议获取对方的 MAC 地址**。

网络接口层主要为网络层提供「链路级别」传输的服务，负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。

## 1.7、总结

TCP/IP 网络通常是由上到下分成 4 层，分别是**应用层，传输层，网络层和网络接口层**。

![网络四层](https://raw.githubusercontent.com/lission/markdownPics/main/network/TCPIP%E7%BD%91%E7%BB%9C%E5%B1%82%E7%BA%A7.webp)

![网络数据结构](https://raw.githubusercontent.com/lission/markdownPics/main/network/TCPIP%E6%95%B0%E6%8D%AE%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F.webp)

网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包。





## 数据链路层

定义对高低电平进行分组方式

> 设备：网桥、以太网交换机、网卡

Ethernet以太网，以太网协议：

- 帧，一组电平信号构成一个数据包，叫做帧

  > 构成:
  >
  > - Head，固定18字节：
  >   - 发送者/源地址：6Byte、
  >   - 接受者/目标地址:6Byte
  >   - 数据类型：6Byte
  > - Data，最短46Byte，最长1500Byte
  > 
  > 长度：最短64字节，最长1518字节，超过此长度就分片发送
  
- MAC地址

- Broadcast广播，Ethernet**使用广播方式进行通信**

## 物理层

高电平用1表示，低电平用0表示，高低是一个相对概念

> 设备：中继器、集线器、双绞线



# HTTP

HTTP是应用层的协议，HTTP协议是建立在TCP协议基础之上的。**WEB使用HTTP协议作为应用层协议，以封装HTTP文本信息，然后使用TCP/IP做传输协议将它发送到网络上**。

