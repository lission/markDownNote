图解TCPIP

# 计算机网络

- 计算机网络根据规模可以分为WAN(wide area network)广域网和LAN(local area network)局域网。
- TCP/IP是通信协议的统称。
- 协议可以分为很多种，每一种协议都明确界定了它的行为规范。两台计算机之间必须能够支持相同协议，并遵循相同协议进行处理，这样才能实现相互通信。
- 计算机从物理连接层面到应用程序软件层面，各组件都必须严格遵循事先达成的**约定**才能实现真正通信。这种约定就是“**协议**”。

## 协议分层

- OSI参考模型，将通信协议中必要功能分成了7层。
- 在这一模型中，每一层接收下一层提供的特定服务，并且负责为自己的上一层提供特定服务。
- 上下层之间交互时所遵循的约定叫做“**接口**”。
- 同一层之间交互所遵循的约定叫做“**协议**”。
- OSI参考模型终究是一个“模型”，它只是对各层作用做了一系列错略界定，并没有对协议和接口进行详细定义。许多通信协议都对应了OSI参考模型7层中的某一层，通过这一点，可以大致了解该协议在整个通信功能中的位置和作用。

|     | 分层名称   | 功能                                                                 | 功能概览                         |
| --- | ---------- | -------------------------------------------------------------------- | -------------------------------- |
| 7   | 应用层     | 针对特定应用的协议                                                   | 电子邮件、远程登录、文件传输     |
| 6   | 表示层     | 设备固有数据格式和网络标准数据格式转换                               |                                  |
| 5   | 会话层     | 会话管理，负责建立和断开会话                                         |                                  |
| 4   | 传输层     | 负责两个节点之间的数据传输。                                         | TCP、UDP                         |
| 3   | 网络层     | 寻址和路由选择                                                       | 在TCP/IP协议中，网络层使用IP协议 |
| 2   | 数据链路层 | 互联设备之间传送和识别数据帧，将0、1序列<br />划分为具有意义的数据帧 | 数据帧和比特流之间的转换         |
| 1   | 物理层     | 以0、1代表电压的高低，灯光的闪灭。界定<br />连接器和网线的规格       | 比特流与电子信号之间的转换       |

## 搭建网络的主要设备及作用

| 名称                     | 作用                             | col3                                                                                                                                                                     |
| ------------------------ | -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 网卡                     | 用于连接计算机网络的设备         |                                                                                                                                                                          |
| 中继器(Repeater)         | 物理层上延长网络的设备           | 1、中继器是对减弱信号进行放大和发送的设备<br />2、中继器通过物理层的连接延长网络<br />3、即使在数据链路层出现某些错误，中继器仍然转发数据<br />4、中继器无法改变传输速度 |
| 网桥(Bridge)/2层交换机   | 数据链路层上延长网络的设备       |                                                                                                                                                                          |
| 路由器(Router)/3层交换机 | 通过网络层转发分组数据的设备     |                                                                                                                                                                          |
| 4~7层交换机              | 处理传输层以上各层网络传输的设备 |                                                                                                                                                                          |
| 网关(Gateway)            | 转换协议的设备                   |                                                                                                                                                                          |

- 在数据传输过程中，两个设备之间数据流动的物理速度称为传输速率。单位bps(Bits Per Second ，每秒比特数)
- 传输速率高也不是指单位数据流动的速度有多快，而是指单位时间内传输的数据量有多少。
- 传输速率又被称作带宽，带宽越大网络传输能力越强。
- 主机之间实际的传输速率被称作吞吐量，其单位与带宽相同，都是bps。吞吐量不仅衡量带宽，也衡量主机的CPU处理能力、网络的拥堵程度等信息。

### 中继器(Repeater)

- 一般情况下，中继器的两端连接的是相同的通信媒介。
- 中继器无法连接一个100Mbps的以太网和另一个10Mbps的以太网，连接两个不同速度网络需要的是网桥或路由器这样的设备。
- 通过中继器并不能无限延长网络，例如一个10Mbps的以太网最多可以用4个中继器分段连接，而一个100Mbps的以太网最多只能连两个中继器。
- 有些中继器可以提供多个端口服务。这种中继器被称作中继集线器或集线器。因此集线器可以看作是多口中继器，每个端口都可以成为一个中继器。

### 网桥(Bridge)/2层交换机

- 网桥连接一个网络和另一个网络
- 网桥根据数据帧的内容转发数据给相邻的其他网络
- 网桥**没有连接网段个数的限制**
- 网桥基本上只用于连接相同类型的网络，但有时也可以连接传输速率不同的网络。
- 网桥是在OSI模型的第2层——**数据链路层**上连接两个网络的设备。它能够识别网络链路层中的数据帧，并将这些数据帧临时储存于内存，再重新生成信号作为一个全新的数据帧转发给相连的另一个网段。由于能够存储这些数据帧，网桥能够连接10BASE-T和100BASE-TX等传输速率完全不同的数据链路，并且不受限制连接网段的个数。
- 数据链路的数据帧中有一个数据位叫做**FCS**，用以**校验数据是否正确送达目的地**。网桥通过检查这个域中的值将那些损坏的数据丢弃，从而避免发送给其他网段。网桥还能通过**地址(MAC地址)自学机制和过滤功能控制网络流量**。
- **自学式网桥**，**会记住曾经通过自己转发的所有数据帧的MAC地址，并保存到自己的内存表中**。由此可以判断哪个网段中包含持有哪类MAC地址的设备。
- 以太网络中经常使用的交换集线器(Hub)，也属于网桥一种。交换集线器中连接电缆的每个都能提供类似网桥的功能。

### 路由器(Router)/3层交换机

- 路由器是在OSI模型的第3层——网络层面上连接两个网络、并对分组报文进行转发的设备。
- 网桥是根据物理地址(MAC地址)进行处理，而路由器则是根据IP地址进行处理的。

### 4~7层交换机

- 4~7层交换机负责处理OSI模型中从**传输层到应用层**的数据。
- 4~7层交换机就是以TCP等协议的传输层及其上面的应用层为基础，分析收发数据，并对其进行特定处理
- 负载均衡器、带宽控制、防火墙等

### 网关

- 网关负责**协议的转换与数据的转发**
- 在同一种类型的协议之间转发数据叫做应用网关

# TCP/IP基础知识

TCP/IP协议，**利用IP进行通信**时所必须用到的**协议群统称**。

TCP/IP网际协议族。

## TCP/IP与OSI参考模型

| OSI        | TCP/IP                                                                                                          |                        |
| ---------- | --------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 应用层     | 应用层<br />DNS,URI,HTML,HTTP,<br />TLS/SSL,SMTP,POP,IMAP,<br />MIME,TELNET,SSH,FTP,<br />SNMP,MIB,SIP,RTP,LDAP | 应用程序               |
| 表示层     |                                                                                                                 |                        |
| 会话层     |                                                                                                                 |                        |
| 传输层     | 传输层<br />TCP,UDP,UDP-Lite,SCTP,DCCP                                                                          | 操作系统               |
| 网络层     | 互联网层<br />ARP,IP(IPv4,IPv6),ICMP                                                                            | 操作系统               |
| 数据链路层 | 网卡层                                                                                                          | 设备驱动程序与网络接口 |
| 物理层     | （硬件）<br />双绞电缆线、无线、光纤                                                                            | 设备驱动程序与网络接口 |

## 硬件(物理层)

- TCP/IP的最底层是负责数据传输的硬件。

## 网络接口层（数据链路层）

- 网络接口层利用以太网中的数据链路层进行通信。
- 驱动程序是在操作系统与硬件之间起桥梁作用的软件。

## 互联网层(网络层)

- 互联网层使用IP协议，**IP协议基于IP地址转发数据包**。
- IP协议的作用是将分组数据包发送到目的主机。

### IP

- IP是**跨越网络传送数据包**，使整个互联网都能接收到数据的协议。
- 使用IP地址作为主机的标识。
- IP协议不具有重发机制，属于非可靠性协议。

### ICMP

- IP数据包在发送途中一旦发生异常导致无法到达对端目标地址时，需要给送端发送一个发生异常的通知。
- ICMP就是为这一功能制定，有时也被用来诊断网络的健康状况。

### ARP

- 从分组数据包的**IP地址中解析出物理地址(MAC地址)**的一种协议。

## 传输层

- 传输层最主要的功能就是能够让应用程序之间实现通信。
- 计算机内部，通常同一时间运行着多个程序，**识别这些应用程序的是端口号**。

### TCP

- TCP是一种**面向有连接**的传输层协议。
- TCP能够正确处理在传输过程中丢包、传输顺序乱掉等异常。
- TCP建立连接需要3次握手，断开连接需要4次挥手。

三次握手：

- 客户端的初始序列号（Seq = x）
- 服务器的初始序列号（Seq = y）
- 对客户端 SYN 报文的确认号（Ack = x + 1）
- 对服务器 SYN 报文的确认号（Ack = y + 1）

```
客户端                         服务器
  |                              |
  |-------- SYN (Seq=x) -------->|
  |<----- SYN+ACK (Seq=y, Ack=x+1) --|
  |-------- ACK (Ack=y+1) ------>|
  |                              |
```

四次挥手：

```
客户端                         服务器
  |                              |
  |-------- FIN (Seq=u) -------->|
  |<----- ACK (Ack=u+1) ---------|
  |                              |
  |<----- FIN (Seq=w) -----------|
  |-------- ACK (Ack=w+1) ------>|
  |                              |
```

### UDP

- UDP，是一种**面向无连接**的传输层协议。
- UDP场用于分组数据较少或多播、广播通信以及视频通信等多媒体领域。

## 应用层(会话层以上的分层)

- TCP/IP 应用的架构绝大多数属于客户端/服务端模型。
- 提供服务的程序交服务端。
- 接受服务的程序叫客户端。
- **WWW(万维网)**
  - 浏览器与服务端之间通信所用的协议是HTPP(HyperText Transfer Protocol)，所传输数据的主要格式是HTML(HyperText Markup Language)。
  - WWW中的HTTP属于OSI应用层协议，而HTML属于表示层协议。
- **E-mail**
  - 发送电子邮件时用到的协议叫做SMTP（Simple Mail Transfer Protocol）,只能发送文本格式
  - 电子邮件格式由MIME协议扩展后，可以发送声音、图像等信息。MIME属于表示层协议。
- **文件传输(FTP，File Transfer Protocol)**
  - 将保存在其他计算机硬盘上的文件转移到本地硬盘上，或将本地硬盘文件传送到其他机器硬盘上。
  - FTP进行文件传输时会建立两个TCP连接，分别是
    - 发出**传输请求**时所需要用到的**控制连接**
    - 实际**传输数据**时所要用到的**数据连接**
- 远程登录(TELNET、SSH)
- 网络管理（SNMP）
  - 在TCP/IP中进行网络管理时，采用SNMP(Simple Network Managment Protocol)协议。
  - 使用SNMP管理的主机、网桥、路由器等称作SNMP代理(Agent)，进行管理的那一段叫管理器（Manager）。SNMP正是这个Manager与Agent用到的协议。
  - 在SNMP的代理端，保存着网络接口的信息、通信数据量、异常数据量以及设备温度等信息。这些信息可以通过MIB(Management Information Base)访问。
  - 在TCP/IP网络管理中，SNMP属于应用协议，MIB属于表示层协议。

## TCP/IP分层模型与通信示例

- 每个分层中，都会对所发送的数据附加一个**首部**。
- 首部包含了该层的必要信息，如发送的目标地址（发送端、接收端地址）、**协议相关信息（上一层协议类型等）**。
- **为协议提供的信息**为**包首部**，所要**发送的内容**为**数据**。

# 数据链路

- 网络拓扑(Topology)，网络的连接和构成的形态。
  - 网络拓扑包括总线型、环型、星型、网状型等。
- MAC地址
  - MAC地址（Media Access Control Address，**媒体访问控制地址**）是**网络设备的唯一硬件标识符**，用于在局域网（LAN）中标识设备。
  - MAC地址长48比特，6字节，一般用十六进制表示。
  - 第1位：单播地址(0)/多播地址(1)
  - 第2位：全局地址(0)/本地地址(1)
  - 第3~24位：由IEEE管理并保证各厂家之间不重复，厂商识别码
  - 第25~48位：由厂商管理并保证产品之间不重复
  - 转发表（Forwarding Table）,无需手工设置，可以自动生成。
    - 数据链路层的每个**通过点**在接到包时，会从中将**源MAC地址**及曾经接收该地址发送的数据包的接口作为**对应关系**记录到转发表中。这一过程也叫自学过程
  - 由于MAC地址没有层次性，转发表中的入口个数与整个数据链路中所有网络设备数量有关。当设备数量增加时，转发表也会随之变大，检索转发表所用时间越长。
    - 当连接多个终端时，有必要将网络分成多个数据链路，采用类似网络层的IP地址一样对地址进行分层管理。
- 环路检测技术
  - 生成树方式
  - 源路由法
- VLAN（Virtual Local Area Network，虚拟局域网）
- FCS(Frame Check Sequence，帧检验序列)，4字节，帧尾的FCS用来检查帧是否有所损坏。
- 无线通信
  - 无线通信通常使用电磁波、红外线、激光等方式进行传播数据。
  - 依据无线距离可分为：
    - 无线PAN，10米左右，蓝牙
    - 无线LAN，100米左右，Wi-Fi
    - 无线MAN，数千米~100千米，WiMAX
    - 无线RAN，200千米~700千米
    - 无线WAN，——，移动通信网络、3G，LTE,4G
- PPP协议
  - PPP(Point-to-Point Protocol)指点对点，即1对1连接计算机的协议。
  - PPP位于OSI参考模型第二层数据链路层
  - PPP主要功能中包括两个协议：
    - LCP，(Link Control Protocol)不依赖上层
    - NCP，(Network Control Protocol)依赖上层，如果上层为IP，此时NCP也叫IPCP(IP Control)
    - LCP主要负责建立和断开连接、设置最大接收单元（MRU）、设置验证协议（PAP或CHAP）以及设置是否进行通信质量监控
    - IPCP负责IP地址设置及是否进行TCP/IP首部压缩等设备
- ATM
  - ATM(Asynchronous Transfer Mode)，是面向连接的一种数据链路，以信元(5字节首部加48字节数据)为单位进行数据传输
  - 线路占用时间短、能够高效传输大容量数据
- VPN 虚拟专用网络
  - IP-VPN，在IP网络(互联网)上建立VPN，网络服务商提供一种在IP网络商使用MPLS(多协议标签转换)技术构建VPN服务，MPLS在IP包中附加一个叫做标签(Label)的信息进行传输控制。用户标签信息不同，在通过MPLS网时，可以判断目标地址。将多个不同用户的VPN信息通过MPLS网加以区分，形成封闭的私有网络。
  - 广域以太网，在数据链路层的以太网上利用VLAN(虚拟局域网)实现VPN的技术

# IP协议

## IP即网际协议

- IP(IPv4、IPv6)相当于OSI参考模型的第3层——网络层
- IP的主要作用就是**在复杂的网络环境中将数据包发给最终的目标地址**
- 网络层及数据链路层的关系
  - 数据链路层提供直连两个设备之间的通信功能，只负责一个区间之间的通信传输
  - 网络层则负责**在没有直连的两个网络之间进行通信**，IP负责**将数据包发给最终的目标地址**。即点对点通信

## IP基础知识

- IP大致分为三大作用模块：IP寻址、路由（最终节点为止的转发）、IP分包与组包
  - IP地址，IP地址用于在“连接到网络中的所有主机中识别出进行通信的目标地址”。TCP/IP通信中**所有主机或路由器必须设定自己的IP地址**。
  - 路由控制（Routing）,将分组数据发送到最终目标地址的功能。
  - 路由控制表（Routing Table），该表记录IP数据在下一步应该发给哪个路由器。IP包将根据这个路由表在各个数据链路上传输。
  - IP是实现多个数据链路之间通信的协议。并对不同数据链路的相异特性进行抽象化。
    - 不同数据数据链路各自最大传输单位不同。为解决该问题，IP进行分片处理，将较大的IP包分成多个较小的IP包。
  - **IP面向无连接**。在发包之前，不需要建立与对端目标地址的连接。上层如果遇到需要发送给IP的数据，数据会立即被压缩成IP包发送出去。
    - 简化，提速。IP为了实现**简单化与高速化**采用面向无连接方式。
    - 为了提高可靠性，上一层的**TCP采用面向有连接型**。
    - **IP只负责将数据转发给目标主机**，**TCP负责保证对端主机确实接收到数据。**

## IP地址的基础知识

- 在TCP/IP通信时，用IP地址识别主机和路由器
- IP地址(IPv4地址)由32位正整数来表示，IP地址在计算机内部以二进制方式被处理。
  - 为方便，将32位IP地址以每8位为一组，分成4组，每组以“.”隔开，再将每组数转换成十进制数
  - IP地址并非是根据主机台数来配置，而是每一台主机上的每一块网卡(NIC)都得设置IP地址。

### IP地址的网络标识和主机标识

- IP地址由网络标识(网络地址)和主机标识(主机地址)两部分组成
- **网络标识（Network ID）**

  - **标识设备所属的网络**。
  - 用于路由选择，确保数据包能够到达正确的网络。
  - IP 地址的前几位（具体位数由子网掩码决定）。
- **主机标识（Host ID）**

  * **标识网络中的具体设备**。
  * 用于在同一网络内区分不同的设备。
  * IP 地址的后几位（具体位数由子网掩码决定）。

### IP地址分类

IPv4 地址分为  **A 类、B 类、C 类、D 类 和 E 类** ，每类地址的范围和用途不同。

| 类别 | 范围                         | 网络标识位 | 默认子网掩码  | 用途                   |
| ---- | ---------------------------- | ---------- | ------------- | ---------------------- |
| A 类 | 1.0.0.0 到 126.0.0.0         | 1~8        | 255.0.0.0     | 大型网络               |
| B 类 | 128.0.0.0 到 191.255.0.0     | 1~16       | 255.255.0.0   | 中型网络               |
| C 类 | 192.0.0.0 到 223.255.255.0   | 1~24       | 255.255.255.0 | 小型网络               |
| D 类 | 224.0.0.0 到 239.255.255.255 |            | 无子网掩码    | 组播（Multicast）      |
| E 类 | 240.0.0.0 到 255.255.255.255 |            | 无子网掩码    | 保留（实验和研究用途） |

- A类地址
- B类地址
- C类地址
- D类地址
- E类地址

1. **特殊地址范围** ：

* **127.0.0.0 ~ 127.255.255.255** ：环回地址（如 `127.0.0.1` 用于本地测试）。
* **0.0.0.0** ：表示本网络或默认路由。
* **255.255.255.255** ：受限广播地址。

1. **私有地址范围** ：

* **A类私有地址** ：`10.0.0.0 ~ 10.255.255.255`
* **B类私有地址** ：`172.16.0.0 ~ 172.31.255.255`
* **C类私有地址** ：`192.168.0.0 ~ 192.168.255.255`

1. **保留地址** ：

* **169.254.0.0/16** ：链路本地地址（DHCP失败时自动分配）。
* **224.0.0.0 ~ 224.0.0.255** ：本地组播地址（如OSPF路由协议）。

### 广播地址

广播地址用于在**同一个链路中相互连接的主机之间发送数据包**。广播将数据发给所有终端主机，由主机IP的上一层去判断是否有必要接收数据。是则接收，否则丢弃。

**将IP地址中的主机地址部分全部设置为1 ，就成为了广播地址。**

广播分为本地广播和直接广播。

- 本地广播，在本网络内的广播
- 直接广播，在不同网络之间的广播

### IP多播

多播用于将包发送给**特定组内**所有主机。多播既可以穿透路由器，又可以实现只给必要的组发送数据包。

- 多播使用D类地址

| 地址       | 内容                                   |
| ---------- | -------------------------------------- |
| 224.0.0.0  | （预定）                               |
| 224.0.0.1  | 子网内所有的系统                       |
| 224.0.0.2  | 子网内所有的路由器                     |
| 224.0.0.5  | OSPF 路由器                            |
| 224.0.0.6  | OSPF 指定路由器                        |
| 224.0.0.9  | RIP2 路由器                            |
| 224.0.0.10 | IGRP 路由器                            |
| 224.0.0.11 | Mobile-Agents                          |
| 224.0.0.12 | DHCP 服务器/中继器代理                 |
| 224.0.0.14 | RSVP-ENCAPSULATION                     |
| 224.0.1.1  | NTP Network Time Protocol              |
| 224.0.1.8  | SUN NIS+ Information Service           |
| 224.0.1.22 | Service Location（SVRLOC）             |
| 224.0.1.33 | RSVP-encap-1                           |
| 224.0.1.34 | RSVP-encap-2                           |
| 224.0.1.35 | Directory Agent Discovery（SVRLOC-DA） |
| 224.0.2.2  | SUN RPC PMAPPROC CALLIT                |

### 子网掩码

现在，一个IP地址的网络标识和主机标识已不再受限于该地址类别，而是由子网掩码通过子网网络地址细分出比A类，B类，C类更小粒度的网络。

- 子网掩码用二进制方式表示，也是一个32位的数字。它对应的网络标识部分的位全部为1，对应的IP地址主机标识部分全部为0
- IP地址与子网掩码分别用两行表示

  - ```
    IP地址   :172.20.100.52
    子网掩码 ：255.255.255.192

    网络地址 ：172.20.100.0
    子网掩码 ：255.255.255.192

    广播地址 ：172.20.100.63
    子网掩码 ：255.255.255.192
    ```
- CIDR表示法，IP地址后加斜杠和数字

  - ```
    IP地址   :172.20.100.52 /26
    网络地址 ：172.20.100.0 /26
    广播地址 ：172.20.100.63 /26
    ```
- 子网掩码可以灵活指定网络标识长度。
- CIDR,采用任意长度分割IP地址的网络标识和主机标识
- VLSM,可变长子网掩码

### 全局地址与私有地址

- 除私有地址之外的IP地址称为全局IP。
- **私有地址范围** ：
  - **A类私有地址** ：`10.0.0.0 ~ 10.255.255.255 （10/8）`
  - **B类私有地址** ：`172.16.0.0 ~ 172.31.255.255 （172.16/12）`
  - **C类私有地址** ：`192.168.0.0 ~ 192.168.255.255 （192.168/16）`
- NAT能够互换私有IP和全局IP
- 全局地址需要在整个互联网范围内保持唯一，私有地址不需要，只要在同一个域里保证唯一即可。
- 私有IP地址结合NAT技术成为解决IP地址分配问题的主流方案。

## 路由控制

路由控制表（Routing Table）,存储路由器或主机信息，在数据发送过程中指明数据包发送目的地。

IP协议始终认为路由表是正确的，然而IP没有制作路由控制表的机制。该表由一个叫做“路由协议”的协议制作而成。

- 静态路由控制，管理员手动设置
- 动态路由控制，路由器与其他路由器相互交换信息时自动刷新。

### IP地址与路由控制

IP地址的网络地址部分用于进行路由控制。

路由控制表中记录着**网络地址**与下一步应该发送至**路由器**的地址。

- 默认路由，指路由表中任何一个地址都能与之匹配的记录。
  - 默认路由一般标记为 0.0.0.0/0 或default
- 主机路由，IP地址/32，如192.168.153.15/32，它的意思是整个IP地址的所有位都将参与路由。
  - 主机路由基于主机上网卡配置的IP地址本身，而不是基于网络地址
  - 主机路由多用于不希望通过网络地址路由的情况
- 回环地址，同一台计算机上的程序之间进行网络通信时所使用的一个默认地址。计算机使用127.0.0.1作为回环地址。或localhost主机名

### 路由控制表的聚合

利用网络地址的**比特分布**可以有效进行**分层配置**。对内即使有多个子网掩码，对外呈现也是同一个网络地址。通过**路由信息聚合可以有效减少路由表条目**。

## IP分割处理与再构成处理

每种数据链路的最大传输单元(MTU)都不尽相同，IP属于数据链路上一层，它必须不受限于不同数据链路的MTU大小。

### IP报文的分片与重组

只要路由器认为有必要，会周而复始进行分片处理。经过分片之后的IP数据报由主机进行重组。

在终结点（目标主机）重组分片了的IP数据报成为现行规范。

### 路径MTU发现

“路径MTU发现”指**从发送端主机到接收端主机之间不需要分片时最大MTU大小**。即路径中存在的所有数据链路中最小的MTU。

- 路径MTU发现从发送主机按照路径MTU大小将数据报分片后进行发送。**避免在中途路由器上进行分片处理**。

## IPv6

IPv6为了根本解决IPv4地址耗尽问题而被标准化的网际协议。

- IPv4的地址长度为4个8位字节，即32比特
- IPv6地址长度是8个16字节，即128比特
- 全局单播地址，世界上唯一的一个地址。前64比特为网络标识，后64比特为主机标识
- 链路本地单播地址，同一个数据链路内唯一的地址
- 唯一本地地址，不进行互联网通信时所使用的地址

## IPv4首部

- 版本（Version）,4比特构成，标识IP首部版本号，IPv4版本号为4
- 首部长度（IHL：Internet Header Length）,4比特构成，表明IP首部大小，单位为4字节。
- 区分服务（TOS：Type Of Service）,表明服务质量
- 总长度（Total Length)，表示IP 首部与数据部分合起来的总字节数。字段长 16 比特，IP 包的最大长度65535
- 标识（ID)，16 比特构成，用于分片重组，同一个分片标识值相同，不同分片标识值不同
- 标志（Flag)，3 比特构成，表示包被分片的信息
- 片偏移（FO,Frangment Offset)，13 比特构成，标识被分片的每一个分段相对于原始数据的位置
- 生存时间（TTL,Time To Live)，8 比特构成，指可以中转多少个路由器，每经过一个路由器 TTL-1，直到变成 0则丢弃该包
- 协议（Protocol)，8 比特构成，表示IP 首部下一个首部隶属于哪个协议。
- 首部校验和（Header Checksum)，16 比特构成，校验数据报首部，确保数据报不被破坏
- 源地址（Source Address)，32 比特构成，发送端 IP 地址
- 目标地址(Destination Address)，32 比特构成，接收端 IP 地址
- 可选项(Options)
- 填充（Padding)，向字段填充 0，调整首部为 32 比特的整数倍
- 数据（Data)

# IP协议相关技术

## DNS

- 管理主机名和 IP 地址之间对应关系的系统
- 域名，为了识别主机名称和组织机构名称的一种具有分层的名称。
- 域名服务器，管理域名的主机和相应的软件，管理所在分层的域的相关信息。其所管理的分层叫 ZONE。每层都有一个域名服务器
- 根部设置的DNS叫做根域名服务器。根域名服务器中，注册了那些管理的域名服务器的 IP 地址。

  - 在根域名服务器的下一层域名服务器中注册了再往下一层域名服务器 IP 的地址
  - 所有的域名服务器都必须注册根域名服务器的 IP 地址，DNS 根据IP地址进行检索时，需要从根域名服务器开始按顺序进行。
- 解析器（Resolver)，进行DNS 查询的主机和软件叫做 DNS 解析器。

  - ```
    域名解析的工作流程：

    1. 客户端首先会发出一个 DNS 请求，问 www.server.com 的 IP 是啥，并发给**本地 DNS 服务器**（也就是客户端的 TCP/IP 设置中填写的 DNS 服务器地址）。
    2. 本地域名服务器收到客户端的请求后，如果缓存里的表格能找到 www.server.com，则它直接返回 IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大， 能告诉我 www.server.com 的 IP 地址吗？” **根域名服务器是最高层次的，它不直接用于域名解析**，但能指明一条道路。
    3. 根 DNS 收到来自本地 DNS 的请求后，发现后置是 .com，说：“www.server.com 这个域名归 .com 区域管理”，我给你 .com 顶级域名服务器地址给你，你去问问它吧。”
    4. 本地 DNS 收到顶级域名服务器的地址后，发起请求问“老二， 你能告诉我 www.server.com 的 IP 地址吗？”
    5. 顶级域名服务器说：“我给你负责 www.server.com 区域的权威 DNS 服务器的地址，你去问它应该能问到”。
    6. 本地 DNS 于是转向问**权威 DNS 服务器**：“老三，www.server.com对应的IP是啥呀？” server.com 的权威 DNS 服务器，**它是域名解析结果的原出处**。为啥叫权威呢？就是我的域名我做主。
    7. 权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。
    8. 本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。
    ```
  - 解析器和域名服务器将最新了解到的信息暂时保存在缓存里。减少每次查询时的性能消耗。
    - 浏览器会先看自身有没有对这个**域名的缓存**，如果有，就直接返回，如果没有，就去问操作系统，**操作系统也会去看自己的缓存**，如果有，就直接返回，如果没有，再去 **hosts 文件**看，也没有，才会去问「本地 DNS 服务器」。

## ARP

- ARP是一种解决地址问题的协议。以目标IP 地址为线索，用来定位下一个应该接收数据分包的网络设备的 MAC 地址。
- ARP借助ARP 请求与 ARP响应两种类型确定MAC 地址。
- 从一个IP 地址发送ARP 请求包以了解其MAC 地址，目标地址将自己的 MAC 地址填入其中的ARP响应包返回到 IP 地址。通过 ARP从 IP 地址获得MAC 地址，实现链路内的 IP 通信。
- MAC 地址缓存，把第一次通过ARP获取的MAC 地址作为 IP对 MAC的映射关系记忆到一个ARP 缓存表中，下一次再向这个IP 地址发送数据时不需再重新发送 ARP 请求。
  - 每执行一次ARP，其对应的缓存内容都会被清除。
-
